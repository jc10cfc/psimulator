\section{Pøeklad adres}
% Tady bude popsán pøeklad adres. Co to je, k cemu slouzi ..

Pøeklad síovıch adres neboli NAT (Network address translation) je zpùsob úpravy paketù síového provozu, kde se pøepisuje zdrojová a/nebo cílová adresa a nìkdy také i port. Obvykle se také pøepoèítává kontrolní souèet, kterı by po úpravì adres nebo portu neodpovídal a byl by takovı paket na prvním routeru zahozen.

NAT se pouívá pøedevším pro pøipojení poèítaèù na lokální síti do internetu, kde jsou takové poèítaèe skryty zpravidla za jednu IP adresu. Navíc technologie pøekladu adres nepatrnì zvyšuje bezpeènost poèítaèù (pøipojenıch za NATem), protoe útoèník nezná opravdou IP adresu \uv{zanatovaného} poèítaèe. Nelze však NAT pouívat místo zabezpeèení.

%------------------------------------------------------------------------------

\subsection{Cisco a NAT}
Cisco podporuje nìkolik druhù pøekladu \cite{cisco:druhy} síovıch adres:

\begin{itemize}
\item statickı NAT
\item dynamickı NAT
\item overloading
\item jakákoliv kombinace statického a dynamického NATu s overloading.
\end{itemize}

Pøeklad adres lze u~cisca nastavit opravdu detailnì, pro tuto práci je však dùleitá pouze úzká podmnoina NATu. Detailní popis fungování pøekladu adres lze nalézt na webovıch stránkách spoleènosti Cisco Systems \cite{cisco:nat}.
Soukromı poèítaè je poèítaè umístìnı v~lokální síti. Je tedy schován za nìjakou IP adresu routeru, kterı provádí pøeklad. Naopak veøejnı poèítaè je takovı poèítaè, kterı není schován za NATem (alespoò z~pohledu soukromého poèítaèe\footnote{Ale i takovıto poèítaè mùe bıt schován za jinım nadøazenım routerem za NAT.}).

\subsubsection{Statickı NAT}
Statickı pøeklad adres umoòuje stanovit pravidla, která øíkají, na jakou adresu má bıt pøeloen poèítaè s~danou IP adresou. Napø.:
\begin{verbatim}
ip nat inside source static 10.10.10.2 147.16.68.5
\end{verbatim} 
Tímto pøíkazem se bude pøekládat paket s~adresou \verb|10.10.10.2| na adresu \verb|147.16.68.5| (za pøedpokladu, e paket pøišel z~rozhraní, které je nastavené jako soukromé, a paket míøí do veøejné sítì - pøes veøejné rozhraní). Statickı NAT funguje i obrácenım smìrem. Je tedy moné zviditelnit poèítaè za NATem pøes statické pravidlo. Pakety od jinıch poèítaèù se pøekládat nebudou. 

Celá situace je znázornìna na obrázku \ref{fig:nat1}. U~paketù od \verb|pocitac1| se bude pøepisovat zdrojová IP adresa na \verb|147.16.68.5|. Zatímco pakety od \verb|pocitac2| zùstanou nezmìnìny.

\begin{figure}[h]
\begin{center}
\includegraphics[width=12cm]{figures/nat1}
\caption{Statickı pøeklad adres}
\label{fig:nat1}
\end{center}
\end{figure}

\newpage


\subsubsection{Dynamickı NAT a overloading}
Dynamickı pøeklad adres je velmi podobnı statickému s~tím rozdílem, e se pravidla generují dynamicky. Je pouze pøiøazen pool\footnote{pool je doslova zásoba èi rezerva} IP adres, ze kterého se pøiøazují adresy (s~portem) pøi pøekladu. Navíc lze omezit adresy sítí, které se mají pøekládat (pøíkaz \verb|access-list|).

Overloading je spíše podmnoina dynamického NATu, kde je povoleno pøiøazovat jednu IP adresu více poèítaèùm. Pakety od rùznıch poèítaèù jsou pak odlišeny jinım portem.

Dynamickı pøeklad probíhá tak, e se nejdøíve zkontrolují access-listy, zda se má vùbec pøekládat. Kdy IP adresa spadá do access-listu, tak se vezme volná IP adresa (pøi metodì overloading mùe bıt vybrána jedna adresa vícekrát) z~poolu, kterı je k~access-listu pøiøazen. Touto vybranou IP adresou poèítaè pøepíše zdrojovou adresu pøíchozího paketu a vytvoøí dynamickı záznam do NAT tabulky. Zpìtnı pøeklad je podstatnì jednodušší. Poèítaè vybere dynamickı záznam, pøepíše cílovou adresu a pøedá paket smìrovacím pravidlùm.

\paragraph{IOS pøíkazy}
Pøidat pool adres lze pøíkazem:
\begin{verbatim}
ip nat pool <POOL_JMENO> <IP_START> <IP_KONEC> prefix <PREFIX>
POOL_JMENO - název poolu IP adres
IP_START - adresa, od které se budou adresy generovat
IP_KONEC - adresa, do které se budou adresy generovat
PREFIX - maska poolu v~poètu jednièkovıch bitù
\end{verbatim} 

Pøístupovı list pro omezení pøekladu adres se pøidá pøes pøíkaz:
\begin{verbatim}
access-list <CISLO> permit <IP> <WILDCARD>
CISLO - identifikátor access-listu
IP - adresa sítì povolenıch IP adres
WILDCARD - maska ve tvaru wildcard (maska = broadcast - wildcard)
\end{verbatim}

Pøiøazení poolu k~access-listu se provadí pøíkazem:
\begin{verbatim}
ip nat inside source list <ACCESS-LIST> pool <POOL> overload?
ACCESS-LIST - identifikátor access-listu
POOL - jméno poolu
overload - nepovinná volba pro overloading
\end{verbatim} 

%------------------------------------------------------------------------------

\subsection{Návrh a implementace NATu}

\subsubsection{Návrh}
Kadı poèítaè bude mít vlastní NAT tabulku. Ta bude sloená ze seznamu \verb|NATzaznam|. Dále NAT tabulka bude potøebovat seznam soukromıch rozhraní a odkaz na jedno veøejné. Bude také potøeba si dret èíslo aktuálního access-listu, poolu a stav pøíznaku overloading. Vše ilustruje obrázek \ref{fig:nat_navrh1}.

\begin{figure}[h]
\begin{center}
\includegraphics[width=9cm]{figures/nat_navrh1}
\caption{Návrh pøekladu adres è.1}
\label{fig:nat_navrh1}
\end{center}
\end{figure}

\subsubsection{Implementace}
Pøi implementaci NAT tabulky vyplula na povrch chyba v~návrhu. Návrh poèítal s~tím, e mùe bıt pouze jeden pool a jeden access-list. Skuteèné cisco si ale pamatuje bez problému i stovky tìchto pøíkazù. Z~tohoto dùvodu jsem musel pùvodní návrh pøizpùsobit. Pøidal jsem nìkolik dalších datovıch struktur, které mi v~pozdìjší fázi velmi usnadnili manipulaci s~NAT tabulkou. Na obrázku \ref{fig:nat_navrh2} je znázornìn novı návrh.

\begin{figure}[b]
\begin{center}
\includegraphics[width=12cm]{figures/nat_navrh2}
\caption{Návrh pøekladu adres è.2 - finální}
\label{fig:nat_navrh2}
\end{center}
\end{figure}

\paragraph{Postup pøekladu adres}
Podrobnı postup pøekladu adres na skuteèném ciscu lze nalézt na webovıch stránkách firmy Cisco \cite{cisco:postup}.

\subparagraph{Smìr ven}
Kdy pøijde paket do poèítaèe, tak se nejdøíve provede reverzní pøeklad\footnote{Reverzní pøeklad by v~èeštinì nejlépe vystihoval vıraz \uv{\textit{odnatování}}.}. Po té poèítaè dle routovací tabulky rozhodne, na které rozhraní paket odešle. Pak pøichází na øadu samotnı akt pøekladu adres. Chování NATu je øízeno nìkolika pravidly:

\begin{itemize}
\item Kdy pøíchozí rozhraní\footnote{Rozhraní, pomocí kterého byl paket do poèítaèe pøijat.} není oznaèeno jako soukromé\footnote{V Cisco IOSu pomocí pøíkazu \uv{ip nat inside}.} nebo odchozí rozhraní není oznaèeno jako veøejné\footnote{Veøejné rozhraní je oznaèeno pøíkazem \uv{ip nat outside}.}, tak se paket pøepošle dál bez pøekladu adres.

\item Pokud lze nalézt statické pravidlo, které by odpovídalo zdrojové adrese, tak se pøeloí zdrojová adresa dle tohoto pravida.

\item Kdy není nalezen ádnı access-list, kterı by odpovídal zdrojové adrese, tak se paket pøepošle bez pøekladu.

\item Kdy zdrojová adresa paketu spadá do access-listu, ke kterému není pøiøazen ádnı pool, tak se pošle zpìt odesílateli \verb|Destination Host Unreacheble|.

\item Kdy v~IP poolu, kterı je pøiøazen k~odpovídajícímu access-listu, dojdou volné IP adresy, tak se pošle zpìt odesílateli \verb|Destination Host Unreacheble|.

\item V~ostatních pøípadech se provede pøeklad adres:
    \begin{enumerate}
    \item Zkusí se nalézt odpovídající dynamické pravidlo. V~pøípadì nenalezení viz následující bod.
    \item Vygeneruje se nová IP adresa z~poolu a vloí se takto vytvoøenı záznam do NAT tabulky.
    \end{enumerate}
\end{itemize}

Vše je lépe znázornìno vıvojovım diagramem \ref{fig:nat_decision}.

\begin{figure}[b]
\begin{center}
\includegraphics[width=16cm]{figures/nat_decision}
\caption{Vıvojovı diagram pøekladu adres}
\label{fig:nat_decision}
\end{center}
\end{figure}

% routovani
% zanatovava se kdyz je prichozi soukrome, kdyz odchozi je verejne
% musit patrit do access-listu (kdyz nepatri, tak jen preposlat bez odnatovani)
% k nemu musi byt prirazen pool (kdyz neni tak se posila zpet DHU)
% kdyz neni volna IP (u došli), tak se posle zpet DHU
% IP je v a-listech && je volná IP tak se natuje:
%     pokud je stat. prav. tak se zanatuje
%     pokud je dyn. prav. tak se zanatuje
%     kdyz nic, tak se vygeneruje novy dyn. zaznam a prida se do tabulky
%     prelozi je zdrojova a odesle do vnejsi site



\subparagraph{Smìr dovnitø - reverzní pøeklad}

Reverzní pøeklad je mnohem jednodušší záleitost. Pøíchozí paket èekají tyto pravidla:
\begin{enumerate}
  \item Nejdøíve se zkontroluje, zda paket pøišel pøes veøejné rozhraní. Kdy je vstupní rozhraní jiné ne veøejné, tak se reverzní pøeklad neprovede.

  \item Pak se prohledají statická pravidla, zda nìjaké odpovídá (vèetnì portu) cílové adrese paketu. Pokud odpovídá, tak se provede reverzní pøeklad.

  \item Kdy se nenajde ani ádnı dynamickı záznam, tak se cílová adresa paketu pøekládat nebude a paket zùstane beze zmìny.
\end{enumerate}


\subsubsection*{}
Z~obou smìrù pøekladu vyplıvá, e statická pravidla mají pøednost pøed dynamickımi záznamy. Pøi testování NATu na školních ciscách jsem zjistil, e cisca zapomínají všechny dynamické záznamy starší cca 10 vteøin. Tato vlastnost byla dodateènì implementována i do této aplikace. Více informací o~konfiguraci statického a dynamického NATu zároveò je na stránkách Cisco Systems \cite{cisco:snat_dnat}.




% odnatovava se kdyz je nastaveno verejne rozhr. a kdyz to taky z nej prislo
% juk do tabulky - staticke, pak dyn.
% pak smerovani
% odeslani do vnitrni site





