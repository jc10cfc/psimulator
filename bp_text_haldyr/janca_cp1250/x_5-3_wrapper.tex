\section{Wrapper smìrovací tabulky}
Routovací tabulka, kterou implementoval kolega, je \uv{šitá} pro linux. Abych ji mohl pouít, musel jsem vytvoøit \verb|CiscoWrapper|, kterı bude linuxovou tabulku ovládat. Hlavní dùvodem pro vytvoøení nìjakého wrapperu je skuteènost, e cisco svoji routovací tabulku vypoèítává z~nahozenıch rozhraní a ze statickıch pravidel vloenıch uivatelem. Má tedy zvláš datovou strukturu pro statická pravidla a pro samotnou routovací tabulku.

Mohl jsem si implementovat kompletnì vlastní routovací tabulku, ale nìjaké podobì wrapperu bych se stejnì nevyhnul. Byla by to tedy zbyteèná práce, která by navíc znamenala urèité zdvojení kódu.

%------------------------------------------------------------------------------

\subsection{Smìrovací tabulka}
Linuxová routovací tabulka je sloena ze záznamù, kde kadı z~nich je tvoøen tìmito polokami: adresát, brána a rozhraní. Existují (pro tuto práci dùleité) dva typy záznamù:
\begin{itemize}
 \item záznam na bránu - pøíznak UG, pøi pøidávání UG záznamu platí, e novì pøidávaná brána musí bıt dosaitelná pøíznakem U~(= nìjakım záznamem na rozhraní)
 \item záznam na rozhraní - pøíznak U, pøevánì záznamy od nahozenıch rozhraní
\end{itemize}

%------------------------------------------------------------------------------

\subsubsection{Vıbìr záznamù}
Pravidla jsou ukládána do routovací tabulky podle masky - ta je hlavním kritériem. Kdy je tedy potøeba rozhodnout, kterı záznam vybrat pro pøíchozí paket, tak se zaène procházet tabulka a vratí se první záznam, kde se shoduje adresát záznamu s~adresátem paketu. Tím zajistíme poadavek cisca, aby se smìrovalo vdy podle adresáta s~nejvyšším poètem jednièek v~masce.

\subsection{Wrapper}
\verb|CiscoWrapper| v~podstatì kopíruje datové struktury linuxové routovací tabulky a pøidává nìkolik obslunıch metod. Nejvìtším oøíškem byla správná aktualizace routovací tabulky na základì wrapperu. Wrapper si pamatuje statické smìrovací záznamy a dle nahozenıch rozhraní generuje správné záznamy do routovací tabulky. 

\subsubsection{Statické záznamy}
Statické smìrovací záznamy se zadávají v~privilegovaném módu pøes pøíkaz \\\verb|ip route <adresa> <maska> <brána OR rozhraní>|. Záznam se nepøidá pouze v~pøípadì neexistujícího rozhraní a adresy ze zakázaného rozsahu. Do zakázaného rozsahu patøí IP adresy ze tøídy D a E. Tøídy adres jsou popsány v~následujícím odstavci. V~dohledné dobì se zaènou uvolòovat IP adresy ze tøídy E kvùli nedostatku IPv4 adres. A se tak stane, tak Cisco bude muset vydat aktualizaci svého IOSu, protoe v~nìm momentálnì nelze pøiøazovat adresy z~tohoto rozsahu.
\begin{verbatim}
Tøída  Zaèátek 1. bajt  Maska           Sítí        Stanic v~kadé síti
A~0       0–127    255.0.0.0       126         16 777 214
B      10      128-191  255.255.0.0     16384       65534
C      110     192-223  255.255.255.0   2 097 152   254
D      1110    224-239  multicast
E      1111    240-255  vyhrazeno jako rezerva
\end{verbatim}
Upravenı vıpis s~Wikipedie \cite{wiki:ip} a ovìøenı z~webu organizace IANA \cite{iana}.

\paragraph{}
Kdy se pøidává záznam s~nedosaitelnou bránou, tak IOS nevypíše ádnou chybovou hlášku (narozdíl od linux, kterı vypíše \verb|SIOCADDRT: No such process|). Záznam se uloí do wrapperu a je pøidán do routovací tabulky ve chvíli, kdy bude dosaitelnı. 

Pøi jakékoliv zmìnì IP adresy na rozhraní èi zmìnì statickıch záznamù se smae celá routovací tabulka a spustí se aktualizaèní funkce \verb|update|. Ta nejdøíve pøidá záznamy na rozhraní (dle nastavenıch adres vsech rozhraních\footnote{V kapitole \ref{prijmiEthernetove} jsem takovému chování øíkal \uv{samo-nastavující záznamy.}}) a pak zaène postupnì propoèítávat jednotlivé záznamy z~wrapperu. Záznam na rozhraní je pøidán automaticky pokud vıstupní rozhraní není shozené. Záznam na bránu se hledá pøes rekurzivní metodu \\\verb|najdiRozhraniProBranu|.

V~mé implementaci je zabudována ochrana proti smyèkám u~záznamù na bránu, která limituje délku takového øetìzu na 100 záznamù na bránu.

Statická pravidla lze vypsat v~privilegovaném módu pøíkazem \verb|show running-config| a generovaná pravidla (tedy obsah routovací tabulky) pøes pøíkaz \verb|show ip route|.

\subsection{Vlastnosti}
Pøi testování školního cisca jsem narazil na zajímavé vlastnosti Cisco IOS. Pøidával jsem postupnì rùzná statická pravidla a nechal si vypisovat stav routovací tabulky.
Nejdøíve jsem vloil tyto záznamy v~konfiguraèním módu:
\begin{verbatim}
ip route 0.0.0.0 0.0.0.0 FastEthernet0/0
ip route 3.3.3.0 255.255.255.0 2.2.2.2
ip route 8.0.0.0 255.0.0.0 9.9.9.254
ip route 13.0.0.0 255.0.0.0 6.6.6.6
ip route 18.18.18.0 255.255.255.0 51.51.51.9
ip route 51.51.51.0 255.255.255.0 21.21.21.244
ip route 172.18.1.0 255.255.255.252 FastEthernet0/0
ip route 192.168.9.0 255.255.255.0 2.2.2.2
\end{verbatim}

Vıpis routovací tabulky pøes pøíkaz \verb|show ip route|:
\begin{verbatim}
     51.0.0.0/24 is subnetted, 1 subnets
S~51.51.51.0 [1/0] via 21.21.21.244
     18.0.0.0/24 is subnetted, 1 subnets
S~18.18.18.0 [1/0] via 51.51.51.9
     3.0.0.0/24 is subnetted, 1 subnets
S~3.3.3.0 [1/0] via 2.2.2.2
     21.0.0.0/24 is subnetted, 1 subnets
C       21.21.21.0 is directly connected, FastEthernet0/0
S~192.168.9.0/24 [1/0] via 2.2.2.2
     172.18.0.0/30 is subnetted, 1 subnets
S~172.18.1.0 is directly connected, FastEthernet0/0
S~8.0.0.0/8 [1/0] via 9.9.9.254
S~13.0.0.0/8 [1/0] via 6.6.6.6
     192.168.2.0/30 is subnetted, 1 subnets
C       192.168.2.8 is directly connected, FastEthernet0/1
S*   0.0.0.0/0 is directly connected, FastEthernet0/0
\end{verbatim} 

Potom jsem smazal defaultní záznam \verb|0.0.0.0 0.0.0.0 FastEthernet0/0| a znovu jsem poøídíl vıpis:
\begin{verbatim}
     51.0.0.0/24 is subnetted, 1 subnets
S~51.51.51.0 [1/0] via 21.21.21.244
     18.0.0.0/24 is subnetted, 1 subnets
S~18.18.18.0 [1/0] via 51.51.51.9
     3.0.0.0/24 is subnetted, 1 subnets
S~3.3.3.0 [1/0] via 2.2.2.2
     21.0.0.0/24 is subnetted, 1 subnets
C       21.21.21.0 is directly connected, FastEthernet0/0
S~192.168.9.0/24 [1/0] via 2.2.2.2
     172.18.0.0/30 is subnetted, 1 subnets
S~172.18.1.0 is directly connected, FastEthernet0/0
S~8.0.0.0/8 [1/0] via 9.9.9.254
S~13.0.0.0/8 [1/0] via 6.6.6.6
     192.168.2.0/30 is subnetted, 1 subnets
C       192.168.2.8 is directly connected, FastEthernet0/1
\end{verbatim} 
Jak je vidìt, tak se defaultní záznam opravdu smazal (záznam \verb|S*| opravdu chybí). Po opìtovném spuštìní pøíkazu \verb|show ip route| po cca 20 vteøinách vypadá vıpis následovnì:
\begin{verbatim}
     51.0.0.0/24 is subnetted, 1 subnets
S~51.51.51.0 [1/0] via 21.21.21.244
     18.0.0.0/24 is subnetted, 1 subnets
S~18.18.18.0 [1/0] via 51.51.51.9
     21.0.0.0/24 is subnetted, 1 subnets
C       21.21.21.0 is directly connected, FastEthernet0/0
     172.18.0.0/30 is subnetted, 1 subnets
S~172.18.1.0 is directly connected, FastEthernet0/0
     192.168.2.0/30 is subnetted, 1 subnets
C       192.168.2.8 is directly connected, FastEthernet0/1
\end{verbatim} 

Obsah routovací tabulky se dramaticky zmìnil. Dlouho jsem si lámal hlavu èím to je zpùsobeno. Ptal jsem se spoluákù co mají CCNA\footnote{Cisco Certified Network Associate} certifikáty a nikdo mi neumìl vysvìtil, jak je moné, e se obsah routovací tabulky mùe mìnit v~èase bez nìjaké tøetí osoby. Dokonce jsem u~známého pouštìl \verb|Cisco Packet Tracer| a zkoušel jsem stejné pøíkazy, ale nebyl jsem schopen to pøes tento simulátor zreprodukovat.

Nakonec jsem pøišel na to, e školní cisco je natolik pomalé, e není schopno propoèítat routovací tabulku v~reálném èase, a tak aktualizuje tabulku s~nìkolika vteøinovımi prodlevami. Prodleva se pohybovala v~závislosti na poètu záznamù v~rozmezí 5-40 vteøin, zkoušel jsem ale pøidat maximálnì asi 15 záznamù, protoe pak u je vıpis routovací tabulky zaèíná bıt nepøíjemnì nepøehlednı. Pøi vyšším poètu záznamù by se prodleva zøejmì zvyšovala. 

\subsection{Odchylky}
Pøi implementaci wrapperu jsem se nìkolikrát odchılil od skuteèného cisca:

\begin{enumerate}
 \item Prodlevu v~aktualizaci routovací tabulky jsem neimplementoval, protoe studenti na ni nemohou témìø narazit. A~kdy si náhodou student všimne, e obsah tabulky nesedí, tak pøíkaz pro vıpis zpravidla spustí znova a vše bude u v~poøádku. Navíc jiná cisca mohou bıt mnohem rychlejší ne ty školní a kdy takovou vlastnost nemá ani oficiální simulátor, tak asi nemá smysl to implementovat zde.

 \item Stanovil jsem limit 100 statickıch pravidel na bránu propojenıch do jednoho dlouhého øetìzu. Nepøepokládám, e by bylo nìco takového potøeba, 100 záznamù by ale mìlo bıt víc ne dost. Pøíklad velmi krátkého øetìzu o tøech záznamech:
\begin{verbatim}
ip route 4.4.4.0 255.255.255.0 6.6.6.6
ip route 6.6.6.0 255.255.255.0 8.8.8.8
ip route 8.8.8.0 255.255.255.0 9.9.9.9
..
\end{verbatim} 

%  \item Jednotlivé záznamy pøi vıpisu routovací tabulky bıvají sdrueny do nadsítí. Mnohdy se takto ale vùbec nesdruuje, 
% \begin{verbatim}
%      147.132.2.0/24 is variably subnetted, 2 subnets, 2 masks
% C       147.132.2.64/26 is directly connected, FastEthernet0/0
% C       147.132.2.128/25 is directly connected, FastEthernet0/1
% S*   0.0.0.0/0 [1/0] via 147.132.2.254
% \end{verbatim} 

\end{enumerate}


